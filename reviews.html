<!DOCTYPE html>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v4.js"></script>
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>

<style>
    .node {
      stroke: #000;
      stroke-width: 1.5px;
    }

    .link {
      stroke: #999;
      stroke-width: 1.5px;
    }

    .text{
       font-family : "helvetica";
       font-size: "12px";
    }

    #search{
        position:relative;
        top: 10%;
        left:40%;
        margin: auto;
    }
    .ui-helper-hidden-accessible { display:none; }
</style>

<body>
  <!--This is where the search bar is.-->
  <div class="ui-widget">
      <input id="search">
      <button id = "search" type="button" onclick="searchNode()">Search</button>
  </div>


<script>
    var bodySelection = d3.select("body");
    var width  = 900, height = 900;
    //Create the SVG Viewport
    var svgContainer = bodySelection.append("svg").attr("width",width).attr("height",height);

    var simulation = d3.forceSimulation()
                    .force("charge", d3.forceManyBody().strength(-150))
                    .force("center", d3.forceCenter(width / 2, height / 2)) //To center svgContainer
                    .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(70))
                    .on("tick", ticked);

    var link = svgContainer.selectAll(".link"),
        node = svgContainer.selectAll(".node"),
        marker = svgContainer.selectAll(".marker"),
        text = svgContainer.selectAll(".text");
    var optArray = [];

    d3.json("reviews.json", function(error, reviews){
              if (error) throw error;


              simulation.nodes(reviews.nodes);
              simulation.force("link").links(reviews.links); //Link nodes

              //Draw Arrow Markers
              svgContainer.append("defs").append("marker")
                    .attr("id","arrowhead")
                    .attr("viewBox", "-0 -5 10 10")
                    .attr("refX", 15.5)
                    .attr("refY", 0)
                    .attr("orient", "auto")
                    .attr("markerWidth",12)
                    .attr("markerHeight", 12)
                    .append("svg:path")
                    .attr("d", "M 0,-5 L 10 ,0 L 0,5")
                    .attr("fill", "#999");

              link = link.data(reviews.links).enter().append("line").attr("class","link").attr("marker-end","url(#arrowhead)");

              node = node.data(reviews.nodes).enter().append("circle")
                      .attr("class","node")
                      .attr("r", function (d){return d.radius;})
                      .style("fill", function(d){return d.color;})
                      .style("stroke-width", 1.5)
                    //  .style("stroke-width",function (d){ return d.touches;})
                      .call(d3.drag().on("drag", dragged));

              text = text.data(reviews.nodes).enter().append("text")
                    .attr("class","text")
                    .attr("text-anchor", "middle")
                    .text(function(d){ return d.id; });


            for (var i = 0; i < reviews.links.length - 1; i++) {
                optArray.push(reviews.links[i].target);
            }
      });

     optArray = optArray.sort();

     //JQuery for search function
     $(function () {
         $("#search").autocomplete({
             source: optArray
         });
     });

     //Helper Methods
         function ticked() {
               link.attr("x1", function(d) { return d.source.x; })
                   .attr("y1", function(d) { return d.source.y; })
                   .attr("x2", function(d) { return d.target.x; })
                   .attr("y2", function(d) { return d.target.y; });

               node.attr("cx", function(d) { return d.x; })
                   .attr("cy", function(d) { return d.y; });

               text.attr("x", function(d){ return d.x; })
                   .attr("y", function(d){ return d.y; });

         }

         //Drag functionality
         function dragged(d){
               node
                   .attr("cx", d.x = d3.event.x)
                   .attr("cy", d.y = d3.event.y);
               ticked();
          }

          function searchNode() {

                //Find the value of the search input
                var selectedVal = document.getElementById("search").value;
                //Filter through node. Filter holds objects that aren't touched by the input word
              /*  var filter =  link.filter(function( d,i){
                    if(  (d.target.id != selectedVal) && (d.source.id != selectedVal)) {
                      return d;
                    }
                });
                filter.style("opacity", "0"); //Make other lines disappear
                //Filter2 holds objects that are touched by the input word
                var filter2 =  link.filter(function( d,i){
                    if(  (d.target.id == selectedVal) || (d.source.id == selectedVal)) {
                      return d;
                    }
                });
                filter2.style("stroke", "orange"); //Make the touched lines orange
                d3.selectAll(".node, .link").transition()
                    .duration(5000) //After this time frame, we will restore all nodes back to how they used to look.
                    .style("opacity", 1)
                    .style("stroke", "#999");

              */
              var objectCheck; //objectCheck holds the group attribute for the inputted node
              var filter =  node.filter(function( d,i){
                    if(  (d.id == selectedVal)) {
                        objectCheck = d.group;
                    }
                });
        //CURRENTLY... OBJ DOES HOLD THE VARIABLE THAT IS SUPPOSED TO BE FILTERED, IT JUST ISNT BEING ADDED TO FILTER2
               var filter2 =  node.filter(function( d,i){
                      var obj = d;
                      (d.group).forEach( function(d){
                        if( !(d in objectCheck)){
                            console.log(obj);
                            return obj;
                        }
                      });
                });
                    console.log(filter2);
              filter2.style("opacity", "0"); //Make other lines disappear
              //  filter2.style("stroke", "orange"); //Make the touched lines orange
                d3.selectAll(".node, .link").transition()
                    .duration(5000) //After this time frame, we will restore all nodes back to how they used to look.
                    .style("opacity", 1)
                    .style("stroke", "#999");




      }

</script>

</body>
</html>
